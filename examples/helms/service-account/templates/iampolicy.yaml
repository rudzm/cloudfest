apiVersion: iam.cnrm.cloud.google.com/v1beta1
kind: IAMPolicy
metadata:
  name: iampolicy-workload-identity-sample
spec:
  resourceRef:
    apiVersion: iam.cnrm.cloud.google.com/v1beta1
    kind: IAMServiceAccount
    name: {{ .Values.serviceAccount.name }}
  bindings:
    - role: roles/iam.workloadIdentityUser
      members:
        - serviceAccount:{{ .Values.global.projectId }}.svc.id.goog[{{ .Values.global.namespace }}/{{ .Values.global.projectId }}]
    {{- range $.Values.serviceAccount.roles }}
    - role: {{ . }}
      members:
        - serviceAccount:{{ $.Values.global.projectId }}.svc.id.goog[{{ $.Values.global.namespace }}/{{ $.Values.global.projectId }}]
    {{- end }}